@page "/host-room"

@using Microsoft.AspNetCore.SignalR.Client
@using System.Security.Claims
@using System.Timers
@using System.Diagnostics
@using TicTacToeGame.Domain.Constants
@using TicTacToeGame.Domain.Enums
@using TicTacToeGame.Domain.Models
@using TicTacToeGame.Domain.Repositories
@using TicTacToeGame.Services.RoomServices
@using TicTacToeGame.WebUI.Hubs

@inject NavigationManager _navigationManager
@inject RoomRepository _roomRepository
@inject GameRepository _gameRepository
@inject PlayerRepository _playerRepository
@inject AuthenticationStateProvider _authenticationStateProvider
@inject RoomManagerService _roomService
@inject TemporaryRoomService _temporaryRoomService

@rendermode InteractiveServer
@implements IDisposable

<section>
    <div>
        <div class="top-row d-flex justify-content-end">
            <a href="join-room">Enter Code</a>
        </div>
        <h3>HostRoom</h3>
        @if (isLoading)
        {
            <div>
                <h2>Loading...</h2>
            </div>
        }
        else
        {
            <div>
                <p>Waiting for another player to join...</p>
            </div>
        }
        @if (_temporaryRoomService.IsTimerElapsed)
        {
            <div class="container">
                <div class="row d-flex align-items-center">
                    <div class="col-7">
                        <div class="alert alert-secondary">Time of your room Id has run out</div>
                    </div>
                    <div class="col-3">
                        <input type="button" class="btn btn-primary" value="Refresh" @onclick="InitializeRoom" />
                    </div>
                </div>
            </div>
        }

        <h4>Room Id: @_temporaryRoomService.ConnectionId</h4>
        <h4>@_temporaryRoomService.WaitingTime</h4>
    </div>
</section>

@code {
    private HubConnection hubConnection;

    private bool isLoading = false;

    public void InitializeRoom()
    {
        _temporaryRoomService.CreateRoom();

        _roomService.OnRoomDeleted = async () =>
       {
           _temporaryRoomService.IsTimerElapsed = true;
           await InvokeAsync(StateHasChanged);
       };

        _roomService.AddRoom(_temporaryRoomService.Room, async () =>
       {
           _temporaryRoomService.IsTimerElapsed = true;
           await InvokeAsync(StateHasChanged);
       });
    }

    protected override async Task OnInitializedAsync()
    {
        AuthenticationState authState = await _authenticationStateProvider.GetAuthenticationStateAsync();
        ClaimsPrincipal? user = authState.User;

        if (user == null)
        {
            throw new Exception("User is not authorized");
        }

        _temporaryRoomService.UpdateComponent += async () => await InvokeAsync(StateHasChanged);

        hubConnection = new HubConnectionBuilder()
            .WithUrl(_navigationManager.ToAbsoluteUri(GameHub.HubUrl))
            .Build();

        hubConnection.On<int, Player>("JoinRoom", async (joinedRoomId, joinPlayer) =>
        {
            if (_roomService.OpenedRooms.Keys.Any(r => r.ConnectionId == joinedRoomId && r.IsOpen))
            {
                if (_temporaryRoomService.ConnectionId == joinedRoomId.ToString())
                {
                    int createdRoomId = _roomService.CreateGame(joinedRoomId, user, joinPlayer);
                    if (createdRoomId == -1)
                    {
                        _navigationManager.NavigateTo("/");
                    }
                    else
                    {
                        await hubConnection.SendAsync("JoinGame", createdRoomId);
                        await hubConnection.SendAsync("AcceptJoining", _temporaryRoomService.Room.ConnectionId, createdRoomId);
                        _navigationManager.NavigateTo("/game");
                    }

                    _ = InvokeAsync(() =>
                    {
                        isLoading = true;
                        StateHasChanged();
                    });
                }
            }
            else
            {
                await hubConnection.SendAsync("DeclineJoining", "Such connection Id is not right");
            }
        });
        await hubConnection.StartAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (_temporaryRoomService.ConnectionId == HostRoomConstants.LOADING_MESSAGE)
            {
                InitializeRoom();
            }
        }
    }

    public void Dispose()
    {
        hubConnection.DisposeAsync();
    }
}
